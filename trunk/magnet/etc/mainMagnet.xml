<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE magnet PUBLIC "-//SAPIA OSS//Magnet DTD 2.0//EN"
                 "http://www.sapia-oss.org/dtd/magnet-2.0.dtd"> 

<magnet xmlns="http://schemas.sapia-oss.org/magnet/" name="MainTestMagnet" description="Test extended magnet with a system launcher">

    <!-- We use a bean shell script to create a directory on the file system. -->
    <script type="bsh" isAbortingOnError="true">
        File aFile = new File(System.getProperty("user.dir")+ "/temp",
                              String.valueOf(System.currentTimeMillis()));

        System.out.println("BSH SCRIPT: Creating temp directory " + aFile.getAbsolutePath());
        aFile.mkdirs();
    </script>

    <!-- Define global properties -->
    <parameters>
        <param name="RootMagnet" value="mainMagnet.xml" />
        <param name="SystemRoot" value="C:\Windows" />
        <param name="message.profile" value="default" scope="system"/>
    </parameters>

    <!-- Define properties used only when the profile dev is executed -->
    <parameters profile="dev">
        <param name="message.profile" value="dev" />
    </parameters>

    <!-- Define variable used only when the profile test is executed -->
    <parameters profile="test">
        <param name="message.profile" value="test" />
    </parameters>

    <!-- Define environment variables that will be used when starting the system launcher.
         The set of environment variables is identified by the name root -->
    <environment id="root">
        <variable name="OS" value="Windows" />
    </environment>

    <!-- Define environment variables that will be used when starting the system launcher.
         The set of environment variables is identified by the name windows_env and extends
         it's parent environment 'root' -->
    <environment id="windows_env" parent="root">
        <variable name="ComSpec" value="${SystemRoot}\system32\cmd.exe" />
        <variable name="CommonProgramFiles" value="&quot;C:\Program Files\Common Files&quot;" />
        <variable name="SystemRoot" value="${SystemRoot}" />
        <variable name="windir" value="${SystemRoot}" />
    </environment>

    <!-- This system launcher will only work on a Windows box. It executes the net
         send command sending the message generated by the profile. A default profile
         is define so if we use the test profile, the launcher still run. -->
    <launcher type="system" os="windows" name="netSend" command="cmd /C start /B net send * ${message}" default="dev2">
        <profile name="dev">
            <!-- We define properties local to this launcher. The message property is use in the
                 command of the system command that it will be executed. -->
            <parameters>
                <param name="message" value="Hello from profile ${message.profile}" />
            </parameters>
            
            <!-- To pass environment variables to the system process we will spawn. We refer to the
              	 windows_env set define earlier as the parent and we override values for testing. -->
            <environment parent="windows_env" >
              <variable name="OS" value="${os.name}" />
              <variable name="windir" value="${SystemRoot}2" />
              <variable name="linux" value="rocks!" />
            </environment>
        </profile>
    </launcher>

</magnet>
